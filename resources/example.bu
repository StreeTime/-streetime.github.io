variant: fcos
version: 1.0.0
passwd:
  users:
    - name: core
      ssh_authorized_keys:
        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDlAl4DVMLfwZnagDboJ9bDPBZwF1EAwuoXf0XDH4FaMX+IEdIyUTiASrau7P8XSw/3Wd0xoJOB5lB8zema2UxphnhHYy5JpzFQ5XjCZmAJtbCswDwwnt6KF3ABHa49GmRVaSW/B24Kz1ZfVDBC7PF2b4oXgJ/aWs7PBO7xyV3Qx3JLpnu1HbWI1GkL+j1YaK3CaxodI3nEoCXaMQFSHje0hMc3C7nWSt46bRyl8j9Fe8CL6JOovhWr+z4yQaAClDZ8LDk/Usu8vcjbgd1o3iG/u5z5d83kkQLEPTaCCiNTB4pA508rxm72lUPhkBguhaEAbiWAX3DPQF/mFUSE8RHMceVdN5vBdfIR/OKekCLqTcz4D4K1ZCiukFYUNe1BfbrguLj98J5ihbGMFacDOC30ix/QGA0wHPUf8VhXjxS8tQ6Ww2HVKP/gmY1TdQv15ih30OpxxRuBwldON5F90HU9zZr3b1AsZZbq1yCmf3UGZOE3iwRrps/TKP4kZam0cgs= s@book.local
      groups:
        - "sudo"
        - "docker"
      
storage:
#  disks:
#  - device: /dev/sda
#    wipe_table: false
#  filesystems:
#  - path: /run/media
#    device: /dev/disk/by-label/mocha
#    format: ext4
  files:
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: |
          mini
    - path: /var/home/core/.bashrc
      mode: 0644
      user:
        name: core
      group:
        name: core
      overwrite: true
      contents:
        inline: |
          alias vim="vi"
          alias ls="ls -lah"
          alias yt="ytfzf -f --detach"
          alias ytdown="ytfzf -dam"
          alias blkid="sudo blkid"
          alias fdisk="sudo fdisk"
          alias shutdown="sudo shutdown now"
systemd:
  units:
    - name: docker.portainer.service
      enabled: true
      contents: |-
        [Unit]
        Description=Portainer Admin Container
        After=docker.service
        Requires=docker.service network.target network-online.target
        [Service]
        Type=oneshot
        RemainAfterExit=yes
        TimeoutStartSec=0
        ExecStartPre=-/usr/bin/docker stop %n
        ExecStartPre=-/usr/bin/docker rm %n
        ExecStartPre=/usr/bin/docker pull portainer/portainer-ce
        ExecStart=-/usr/bin/mkdir -p /mnt/shared_nfs/portainer_data
        # Privileged mode is required for binding to local socket to work due to SELINUX (https://github.com/portainer/portainer/issues/849)
        ExecStart=/usr/bin/docker run --privileged=true -d -p 9000:9000 --name %n --restart always -v /var/run/docker.sock:/var/run/docker.sock -v /var/portainer_data:/data portainer/portainer-ce
        ExecStop=/usr/bin/docker stop -t 15 %n
        [Install]
        WantedBy=multi-user.target

    - name: docker.navidrome.service
      enabled: true
      contents: |-
        [Unit]
        Description=Navidrome Music Server
        After=docker.service
        Requires=docker.service network.target network-online.target
        [Service]
        Type=oneshot
        RemainAfterExit=yes
        TimeoutStartSec=0
        ExecStartPre=-/usr/bin/docker stop %n
        ExecStartPre=-/usr/bin/docker rm %n
        ExecStartPre=/usr/bin/docker pull deluan/navidrome
        ExecStart=-/usr/bin/mkdir -p /mnt/shared_nfs/navidrome_data
        ExecStart=/usr/bin/docker run --privileged=true -d -p 4533:4533 --name %n --restart always -v /var/run/docker.sock:/var/run/docker.sock -v /var/navidrome_data:/data "/run/media/music:/music:ro
        ExecStop=/usr/bin/docker stop -t 15 %n
        [Install]
        WantedBy=multi-user.target

